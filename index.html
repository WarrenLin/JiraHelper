<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JIRA 後台列表</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 20px; color: #111; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    #controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; align-items: center; }
    input, select, button { font-size: 14px; padding: 6px 8px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; font-size: 14px; }
    th { background: #f3f4f6; text-align: left; }
    tbody tr:nth-child(odd) { background: #fafafa; }
    .pill { padding: 2px 8px; border-radius: 999px; font-size: 12px; display: inline-block; }
    .status-Done { background: #d1fae5; color: #065f46; }
    .status-In-Progress { background: #fef3c7; color: #92400e; }
    .status-To-Do { background: #e5e7eb; color: #374151; }
    .status-等候驗收 { background: #e0e7ff; color: #3730a3; }
    .assignee { display: flex; align-items: center; gap: 6px; }
    .assignee img { width: 18px; height: 18px; border-radius: 50%; }
    .muted { color: #6b7280; }
    .link { color: #2563eb; text-decoration: none; }
    .link:hover { text-decoration: underline; }
    .error { color: #b91c1c; }
    #loader { font-size: 14px; }
    .summary-row { font-weight: bold; background-color: #f3f4f6; }
  </style>
</head>
<body>
  <h1>JIRA 後台列表</h1>
  <div id="controls">
    <span id="total"></span>
    <input id="project" placeholder="Project (如 HRTX)" value="HRTX" style="width:120px">
    <select id="sprint" style="width: 200px;"></select>
    <input id="components" placeholder="Components(逗號分隔)" value="Android_RD" style="width:180px">
    <button id="apply">套用</button>
    <input id="search" placeholder="搜尋關鍵字或單號">
    <select id="status"><option value="">全部狀態</option><option>To Do</option><option>In Progress</option><option>等候驗收</option><option>Done</option></select>
    <select id="type"><option value="">全部類型</option><option>Task</option><option>Stage-bug</option><option>Bug</option><option>Sub-task</option></select>
    <select id="assignee"><option value="">全部指派</option></select>
    <button id="export">匯出 CSV</button>
    <span id="loader" style="display: none;">讀取中...</span>
  </div>
  <div id="error-display" class="error"></div>
  <table>
    <thead>
      <tr>
        <th style="width:110px">Key</th>
        <th>摘要</th>
        <th style="width:140px">狀態</th>
        <th style="width:180px">指派</th>
        <th style="width:120px">類型</th>
        <th style="width:110px">Story Points</th>
        <th style="width:120px">Original Estimate</th>
        <th style="width:120px">Time Spent</th>
      </tr>
    </thead>
    <tbody id="issues-tbody"></tbody>
  </table>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const projectInput = document.getElementById('project');
  const sprintSelect = document.getElementById('sprint');
  const componentsInput = document.getElementById('components');
  const applyBtn = document.getElementById('apply');
  const searchInput = document.getElementById('search');
  const statusSelect = document.getElementById('status');
  const typeSelect = document.getElementById('type');
  const assigneeSelect = document.getElementById('assignee');
  const exportBtn = document.getElementById('export');
  const totalEl = document.getElementById('total');
  const tbody = document.getElementById('issues-tbody');
  const errorDisplay = document.getElementById('error-display');
  const loader = document.getElementById('loader');

  let allIssues = [];

  const secondsToReadable = (seconds) => {
      if (seconds === null || seconds === undefined) return '';
      if (seconds === 0) return '0m';
      
      const hoursInDay = 8;
      const minutesInHour = 60;
      const secondsInMinute = 60;
      const secondsInHour = secondsInMinute * minutesInHour;
      const secondsInDay = secondsInHour * hoursInDay;

      let remainingSeconds = seconds;
      
      const days = Math.floor(remainingSeconds / secondsInDay);
      remainingSeconds %= secondsInDay;
      
      const hours = Math.floor(remainingSeconds / secondsInHour);
      remainingSeconds %= secondsInHour;

      const minutes = Math.floor(remainingSeconds / secondsInMinute);

      let result = '';
      if (days > 0) result += `${days}d `;
      if (hours > 0) result += `${hours}h `;
      if (minutes > 0) result += `${minutes}m`;
      
      return result.trim() || '0m';
  };

  const fetchSprints = async (projectKey) => {
    if (!projectKey) {
      sprintSelect.innerHTML = '<option value="">請先輸入專案</option>';
      return;
    }
    sprintSelect.innerHTML = '<option value="">讀取中...</option>';
    try {
      const response = await fetch(`/api/sprints?projectKey=${projectKey}`);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const sprints = await response.json();
      
      sprintSelect.innerHTML = ''; // Clear options
      if (sprints.length > 0) {
        sprints.forEach(sprint => {
          const option = document.createElement('option');
          option.value = sprint.id;
          option.textContent = `${sprint.name} (${sprint.id})`;
          sprintSelect.appendChild(option);
        });
      } else {
        sprintSelect.innerHTML = '<option value="">找不到進行中的 Sprint</option>';
      }
    } catch (e) {
      console.error('Error fetching sprints:', e);
      sprintSelect.innerHTML = '<option value="">讀取 Sprint 失敗</option>';
    }
  };

  const fetchIssues = () => {
    errorDisplay.textContent = '';
    loader.style.display = 'inline';
    tbody.innerHTML = '';
    totalEl.textContent = '';

    const project = projectInput.value.trim();
    const sprint = sprintSelect.value;
    const components = componentsInput.value.trim();
    
    if (!project || !sprint) {
        loader.style.display = 'none';
        errorDisplay.textContent = '請輸入專案並選擇 Sprint。';
        return;
    }

    let jqlParts = [];
    jqlParts.push(`project = "${project}"`);
    jqlParts.push(`sprint = ${sprint}`);
    if (components) {
        const componentsQuery = components.split(',').map(c => `"${c.trim()}"`).join(',');
        jqlParts.push(`component IN (${componentsQuery})`);
    }
    jqlParts.push('type IN (Task, Stage-bug, Bug, Sub-task)');
    
    const jql = jqlParts.join(' AND ') + ' ORDER BY status DESC, originalEstimate ASC';

    fetch(`/api/issues?jql=${encodeURIComponent(jql)}`)
      .then(res => {
        if (!res.ok) throw new Error(`伺服器錯誤: ${res.status}`);
        return res.json();
      })
      .then(data => {
        loader.style.display = 'none';
        if (data.error) throw new Error(data.message);
        
        allIssues = data.issues || [];
        totalEl.textContent = `共 ${data.total || 0} 筆`;
        renderIssues(allIssues);
        populateAssigneeFilter(allIssues);
      })
      .catch(err => {
        loader.style.display = 'none';
        console.error('Error fetching issues:', err);
        errorDisplay.textContent = `讀取失敗: ${err.message}`;
      });
  };

  const renderIssues = (issues) => {
    tbody.innerHTML = '';
    if (!issues || issues.length === 0) return;

    let totalStoryPoints = 0;
    let totalOriginalEstimate = 0;
    let totalTimeSpent = 0;
    const issueTypeCounts = {};

    issues.forEach(issue => {
      const row = document.createElement('tr');
      const statusClass = issue.status ? `status-${issue.status.name.replace(/\s+/g, '-')}` : '';
      row.innerHTML = `
        <td><a href="https://cmoneyteam.atlassian.net/browse/${issue.key}" target="_blank" class="link">${issue.key}</a></td>
        <td>${issue.summary || ''}</td>
        <td><span class="pill ${statusClass}">${issue.status ? issue.status.name : 'N/A'}</span></td>
        <td>
          ${issue.assignee ? `<div class="assignee"><img src="${issue.assignee.avatar_url}" alt=""> ${issue.assignee.display_name}</div>` : '<span class="muted">未指派</span>'}
        </td>
        <td>${issue.issue_type ? issue.issue_type.name : ''}</td>
        <td>${issue.storyPoints || ''}</td>
        <td>${secondsToReadable(issue.originalEstimate)}</td>
        <td>${secondsToReadable(issue.timeSpent)}</td>
      `;
      tbody.appendChild(row);

      // Accumulate totals
      if (issue.storyPoints) {
          totalStoryPoints += parseFloat(issue.storyPoints);
      }
      if (issue.originalEstimate) {
          totalOriginalEstimate += issue.originalEstimate;
      }
      if (issue.timeSpent) {
          totalTimeSpent += issue.timeSpent;
      }
      if (issue.issue_type?.name) {
          issueTypeCounts[issue.issue_type.name] = (issueTypeCounts[issue.issue_type.name] || 0) + 1;
      }
    });

    // Create and append summary row
    const summaryRow = document.createElement('tr');
    summaryRow.className = 'summary-row';

    const typeSummary = Object.entries(issueTypeCounts)
        .map(([key, value]) => `${key}: ${value}`)
        .join(', ');

    summaryRow.innerHTML = `
        <td colspan="4">總計 (Total)</td>
        <td>${typeSummary}</td>
        <td>${totalStoryPoints.toFixed(1)}</td>
        <td>${secondsToReadable(totalOriginalEstimate)}</td>
        <td>${secondsToReadable(totalTimeSpent)}</td>
    `;
    tbody.appendChild(summaryRow);
  };

  const populateAssigneeFilter = (issues) => {
      const assignees = new Map();
      issues.forEach(issue => {
          if (issue.assignee && !assignees.has(issue.assignee.display_name)) {
              assignees.set(issue.assignee.display_name, issue.assignee);
          }
      });
      
      const currentAssignee = assigneeSelect.value;
      assigneeSelect.innerHTML = '<option value="">全部指派</option>';
      
      [...assignees.keys()].sort().forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          assigneeSelect.appendChild(option);
      });
      assigneeSelect.value = currentAssignee;
  };

  const filterIssues = () => {
      const searchTerm = searchInput.value.toLowerCase();
      const selectedStatus = statusSelect.value;
      const selectedType = typeSelect.value;
      const selectedAssignee = assigneeSelect.value;

      const filtered = allIssues.filter(issue => {
          const summaryMatch = issue.summary?.toLowerCase().includes(searchTerm);
          const keyMatch = issue.key?.toLowerCase().includes(searchTerm);
          const statusMatch = !selectedStatus || issue.status?.name === selectedStatus;
          const typeMatch = !selectedType || issue.issue_type?.name === selectedType;
          const assigneeMatch = !selectedAssignee || issue.assignee?.display_name === selectedAssignee;
          return (summaryMatch || keyMatch) && statusMatch && typeMatch && assigneeMatch;
      });
      // When filtering, we re-render the table which will also add the summary row for the filtered data
      renderIssues(filtered);
  };

  const exportToCSV = () => {
    const headers = ['Key', '摘要', '狀態', '指派', '類型', 'Story Points', 'Original Estimate (sec)', 'Time Spent (sec)'];
    const rows = allIssues.map(issue => [
      issue.key,
      `"${(issue.summary || '').replace(/"/g, '""' )}"`,
      issue.status ? issue.status.name : '',
      issue.assignee ? issue.assignee.display_name : '',
      issue.issue_type ? issue.issue_type.name : '',
      issue.storyPoints || '',
      issue.originalEstimate || '',
      issue.timeSpent || ''
    ]);

    let csvContent = "data:text/csv;charset=utf-8," 
      + headers.join(",") + "\n"
      + rows.map(e => e.join(",")).join("\n");
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "jira_issues.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Event Listeners
  projectInput.addEventListener('change', () => fetchSprints(projectInput.value.trim()));
  applyBtn.addEventListener('click', fetchIssues);
  searchInput.addEventListener('input', filterIssues);
  statusSelect.addEventListener('change', filterIssues);
  typeSelect.addEventListener('change', filterIssues);
  assigneeSelect.addEventListener('change', filterIssues);
  exportBtn.addEventListener('click', exportToCSV);

  // Initial Load
  fetchSprints(projectInput.value.trim());
});
</script>
</body>
</html>