<!doctype html><html lang="zh-Hant"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>JIRA 後台列表</title><style>body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:20px;color:#111}h1{font-size:20px;margin:0 0 12px}#controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}input,select,button{font-size:14px;padding:6px 8px}table{border-collapse:collapse;width:100%}th,td{border:1px solid #e5e7eb;padding:8px;font-size:14px}th{background:#f3f4f6;text-align:left}tbody tr:nth-child(odd){background:#fafafa}.pill{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block}.status-Done{background:#d1fae5;color:#065f46}.status-In\ Progress{background:#fef3c7;color:#92400e}.status-To\ Do{background:#e5e7eb;color:#374151}.status-等候驗收{background:#e0e7ff;color:#3730a3}.assignee{display:flex;align-items:center;gap:6px}.assignee img{width:18px;height:18px;border-radius:50%}.muted{color:#6b7280}.link{color:#2563eb;text-decoration:none}.link:hover{text-decoration:underline}.error{color:#b91c1c}</style></head><body><h1>JIRA 後台列表</h1><div id="controls"><span id="total"></span><input id="project" placeholder="Project (如 HRTX)" value="HRTX" style="width:120px"><input id="sprint" placeholder="Sprint ID" value="5649" style="width:120px"><input id="components" placeholder="Components(逗號分隔)" value="Android_RD" style="width:180px"><button id="apply">套用</button><input id="search" placeholder="搜尋關鍵字或單號"><select id="status"><option value="">全部狀態</option><option>To Do</option><option>In Progress</option><option>等候驗收</option><option>Done</option></select><select id="assignee"><option value="">全部指派</option></select><button id="export">匯出 CSV</button></div><table><thead><tr><th style="width:110px">Key</th><th>摘要</th><th style="width:140px">狀態</th><th style="width:180px">指派</th><th style="width:120px">類型</th><th style="width:110px">Story Points</th><th style="width:120px">Original Estimate</th><th style="width:110px">Time Spent</th></tr></thead><tbody id="rows"></tbody><tfoot><tr><td colspan="5">合計</td><td id="sum-sp"></td><td id="sum-oe"></td><td id="sum-ts"></td></tr><tr><td colspan="8" id="sum-status"></td></tr></tfoot></table><script>let RAW=[];const pill=t=>t?`<span class="pill status-${t.replace(/\s/g," ")}">${t}</span>`:"";const assigneeCell=t=>{if(!t)return '<span class="muted">Unassigned</span>';const img=t.avatar_url?'<img src="'+t.avatar_url+'">':'';return `<div class="assignee">${img}<span>${t.display_name||""}</span></div>`};const keyLink=t=>t?`<a class=link href="https://cmoneyteam.atlassian.net/browse/${t}" target=_blank rel=noopener>${t}</a>`:"";const populateAssignees=()=>{const sel=document.getElementById('assignee');if(!sel)return;const prev=sel.value;const set=new Set();RAW.forEach(x=>{if(x.assignee&&x.assignee.display_name)set.add(x.assignee.display_name)});const opts=['<option value="">全部指派</option>'].concat(Array.from(set).sort().map(n=>`<option>${n}</option>`)).join('');sel.innerHTML=opts;if(prev&&Array.from(sel.options).some(o=>o.value===prev))sel.value=prev};const parseDur=t=>{if(!t)return 0;let m=0;const re=/(\d+)\s*d|(\d+)\s*h|(\d+)\s*m/gi;let a;while((a=re.exec(t))){if(a[1])m+=parseInt(a[1],10)*1440;else if(a[2])m+=parseInt(a[2],10)*60;else if(a[3])m+=parseInt(a[3],10);}return m};const fmtDur=m=>{if(!m||m<=0)return "";const d=Math.floor(m/1440);m-=d*1440;const h=Math.floor(m/60);m-=h*60;const parts=[];if(d)parts.push(`${d}d`);if(h)parts.push(`${h}h`);if(m)parts.push(`${m}m`);return parts.join(' ')||'0m'};function render(){const body=document.getElementById("rows");const q=document.getElementById("search").value.trim().toLowerCase();const st=document.getElementById("status").value;const an=document.getElementById('assignee').value;let arr=RAW.map(x=>({key:x.key,summary:x.summary||"",status:(x.status&&x.status.name)||"",assignee:x.assignee||null,type:(x.issue_type&&x.issue_type.name)||"",originalEstimate:x.originalEstimate||null,storyPoints:x.storyPoints??null,timeSpent:x.timeSpent??null}));arr=arr.filter(x=>{const okStatus=!st||x.status===st;const okQ=!q||[x.key,x.summary,x.status,x.type,(x.assignee&&x.assignee.display_name)||"",x.priority||""].join(" ").toLowerCase().includes(q);const okAssignee=!an||(x.assignee&&x.assignee.display_name===an);return okStatus&&okQ&&okAssignee});const order={Done:3,"等候驗收":2,"In Progress":1,"To Do":0};arr.sort((a,b)=>{const s=(order[b.status]??-1)-(order[a.status]??-1);if(s) return s;const e=(a.originalEstimate??1e15)-(b.originalEstimate??1e15);if(e) return e;return a.key.localeCompare(b.key)});document.getElementById("total").textContent=`共${arr.length}筆`;body.innerHTML=arr.map(x=>`<tr><td>${keyLink(x.key)}</td><td>${x.summary}</td><td>${pill(x.status)}</td><td>${assigneeCell(x.assignee)}</td><td>${x.type}</td><td>${x.storyPoints??""}</td><td>${x.originalEstimate??""}</td><td>${x.timeSpent??""}</td></tr>`).join("");const sumSp=arr.reduce((s,x)=>s+(Number(x.storyPoints)||0),0);const sumOe=fmtDur(arr.reduce((s,x)=>s+parseDur(x.originalEstimate),0));const sumTs=fmtDur(arr.reduce((s,x)=>s+parseDur(x.timeSpent),0));document.getElementById('sum-sp').textContent=sumSp||"";document.getElementById('sum-oe').textContent=sumOe;document.getElementById('sum-ts').textContent=sumTs;const sc=arr.reduce((m,x)=>{const k=x.status||'';m[k]=(m[k]||0)+1;return m},{});document.getElementById('sum-status').textContent=Object.entries(sc).map(([k,v])=>`${k||'未指定'}: ${v}`).join(' / ')}async function fetchData(){document.getElementById("total").textContent="載入中…";document.getElementById("rows").innerHTML="";try{const pj=(document.getElementById('project').value||'').trim();const sp=(document.getElementById('sprint').value||'').trim();let jql="type IN (Stage-bug, Bug, Sub-task) AND status IN (\"To Do\", \"In Progress\", Done, 等候驗收)";if(pj) jql+=` AND project = ${pj}`;if(sp) jql+=` AND sprint = ${sp}`;const comps=(document.getElementById('components').value||'').trim();if(comps){const list=comps.split(',').map(s=>s.trim()).filter(Boolean).map(s=>`"${s}"`).join(',');jql+=` AND component in (${list})`;}jql+=" ORDER BY status DESC, originalEstimate ASC";const url="/api/issues?"+new URLSearchParams({jql});const res=await fetch(url);if(!res.ok) throw new Error(res.status+" "+res.statusText);const data=await res.json();RAW=data.issues||[];populateAssignees();render()}catch(e){document.getElementById("total").innerHTML=`<span class=error>讀取失敗</span>`}}document.getElementById('apply').addEventListener('click',fetchData);document.getElementById("search").addEventListener("input",render);document.getElementById("status").addEventListener("change",render);document.getElementById('assignee').addEventListener('change',render);document.getElementById("export").addEventListener("click",()=>{const header=["Key","摘要","狀態","指派","類型","Story Points","Original Estimate","Time Spent"].join(",");const rows=Array.from(document.querySelectorAll("#rows tr")).map(tr=>Array.from(tr.children).slice(0,8).map(td=>`"${(td.textContent||"").replace(/"/g,'""')}"`).join(",")).join("\n");const csv=header+"\n"+rows;const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="jira_export.csv";a.click();URL.revokeObjectURL(url)});fetchData();</script></body></html>